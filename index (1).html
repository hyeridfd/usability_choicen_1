import os, base64
import streamlit as st
import streamlit.components.v1 as components

def render_index_html_with_injected_xlsx(
    html_height: int = 900,
    xlsx_candidates=None,
    html_file_path: str | None = None,
):
    """
    index.html 내용을 파이썬 문자열(INDEX_HTML)로 포함하고,
    존재하는 엑셀을 base64로 주입하여 Streamlit에서 바로 렌더합니다.

    - html_file_path 를 주면, 내부 문자열 대신 해당 파일 내용을 사용합니다(선택).
    - xlsx_candidates 순서대로 존재여부를 확인해 첫 번째 파일을 주입합니다.
    """
    if xlsx_candidates is None:
        xlsx_candidates = [
            "menu.xlsx",
        ]

    # 1) HTML 본문 준비 (파일 경로가 주어지면 파일 사용, 아니면 내장 문자열 사용)
    if html_file_path and os.path.exists(html_file_path):
        try:
            with open(html_file_path, "r", encoding="utf-8") as f:
                html_content = f.read()
        except Exception:
            with open(html_file_path, "r", encoding="cp949", errors="ignore") as f:
                html_content = f.read()
    else:
        html_content = INDEX_HTML  # 아래에 정의된 전체 HTML 문자열

    # 2) 엑셀 후보 중 첫 번째 존재 파일을 base64 인코딩
    xlsx_path = next((p for p in xlsx_candidates if os.path.exists(p)), None)
    if xlsx_path:
        with open(xlsx_path, "rb") as xf:
            b64 = base64.b64encode(xf.read()).decode()
        inject_script = f"<script>window.__XLSX_BASE64__='{b64}';</script>"
    else:
        # 주입 없음 → HTML 내부에서 fetch() 경로로 폴백
        inject_script = "<script>window.__XLSX_BASE64__=null;</script>"

    # 3) 주입 스크립트 + HTML 합치기 후 렌더
    final_html = inject_script + html_content
    components.html(final_html, height=html_height, scrolling=True)


# ==============================
# ↓↓↓ 여기부터 index.html 본문 ↓↓↓
# (주입(base64) 모드 + fetch 폴백 모두 지원)
# ==============================
INDEX_HTML = r"""<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>메뉴 관리</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Malgun Gothic', sans-serif; background:#f5f5f5; color:#333; }
    .header { background:linear-gradient(to right,#5b6caa,#7b8bc4); color:#fff; padding:12px 20px; font-weight:700; display:flex; gap:10px; align-items:center; }
    .fics-logo { background:#3d4d7a; padding:4px 12px; border-radius:4px; }
    .container { background:#fff; margin:20px; border:1px solid #ddd; box-shadow:0 2px 4px rgba(0,0,0,.08); }
    .title-bar { background:#f8f9fa; padding:12px 16px; border-bottom:1px solid #e5e7eb; font-weight:700; }
    .content { padding:18px; }
    .info-section { display:flex; gap:20px; flex-wrap:wrap; margin-bottom:18px; padding:12px; background:#f8f9fa; border:1px solid #e5e7eb; border-radius:6px;}
    .info-item { display:flex; gap:8px; align-items:center; }
    .category-buttons { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px; }
    .category-btn { padding:8px 16px; border:1px solid #9ca3af; background:linear-gradient(to bottom,#fafafa,#e8e8e8); border-radius:6px; cursor:pointer; font-weight:600; }
    .category-btn.active { background:linear-gradient(to bottom,#5b6caa,#4a5a99); color:#fff; border-color:#3d4d7a; }
    .search-row { display:flex; gap:10px; margin-bottom:12px; align-items:center; }
    .search-input { flex:1; padding:10px 12px; border:1px solid #e5e7eb; border-radius:6px; }
    .search-btn { padding:10px 16px; border:none; border-radius:6px; background:#4a5a99; color:#fff; font-weight:700; cursor:pointer; }
    .filters { display:grid; grid-template-columns: repeat(4, minmax(160px,1fr)); gap:10px; margin-bottom:14px; }
    .filter { display:flex; flex-direction:column; gap:6px; }
    .filter label { font-size:12px; color:#6b7280; font-weight:700; }
    .filter select { padding:10px 12px; border:1px solid #e5e7eb; border-radius:6px; }
    .table-container { border:1px solid #e5e7eb; border-radius:8px; overflow:hidden; }
    table { width:100%; border-collapse:collapse; }
    thead { background:linear-gradient(to bottom,#6b7baa,#5b6b9a); color:#fff; }
    th, td { padding:12px 10px; text-align:center; border-bottom:1px solid #eef2f7; }
    tbody tr:hover { background:#f8fafc; }
    td.left { text-align:left; padding-left:18px; }
    .no-data { text-align:center; padding:36px 20px; color:#6b7280; }
    .no-data-icon { font-size:40px; opacity:.35; margin-bottom:8px; }
    .count-badge { background:#dc3545; color:#fff; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:700; }
  </style>
</head>
<body>
  <div class="header">
    <span class="fics-logo">FICS</span>
    <span>(주)초이스엔 메뉴 관리</span>
  </div>

  <div class="container">
    <div class="title-bar">메뉴관리</div>
    <div class="content">
      <div class="info-section">
        <div class="info-item"><strong>• 사업장:</strong> (주)초이스엔</div>
        <div class="info-item"><strong>• 업태/종목:</strong> 메뉴설계</div>
        <div class="info-item"><strong>• 총 메뉴 수:</strong> <span id="totalCount" class="count-badge">0</span></div>
      </div>

      <div class="category-buttons">
        <button class="category-btn" onclick="filterByCategory('all', event)">전체</button>
        <button class="category-btn" onclick="filterByCategory('밥', event)">밥</button>
        <button class="category-btn" onclick="filterByCategory('국', event)">국</button>
        <button class="category-btn" onclick="filterByCategory('주찬', event)">주찬</button>
        <button class="category-btn" onclick="filterByCategory('부찬', event)">부찬</button>
        <button class="category-btn" onclick="filterByCategory('김치', event)">김치</button>
      </div>

      <div class="search-row">
        <input id="searchInput" class="search-input" type="text" placeholder="메뉴명 검색…" oninput="applyAllFilters()" />
        <button class="search-btn" onclick="applyAllFilters()">검색</button>
      </div>

      <!-- 동적 드롭다운(카테고리 선택 시 노출) -->
      <div id="advancedFilters" class="filters" style="display:none;">
        <div class="filter">
          <label for="codeSelect">음식 분류코드</label>
          <select id="codeSelect" onchange="syncCascades(); applyAllFilters();"></select>
        </div>
        <div class="filter">
          <label for="largeSelect">대분류</label>
          <select id="largeSelect" onchange="syncCascades(); applyAllFilters();"></select>
        </div>
        <div class="filter">
          <label for="middleSelect">중분류</label>
          <select id="middleSelect" onchange="syncCascades(); applyAllFilters();"></select>
        </div>
        <div class="filter">
          <label for="cookSelect">조리법 유형</label>
          <select id="cookSelect" onchange="syncCascades(); applyAllFilters();"></select>
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th style="width:60px;">#</th>
              <th>메뉴명</th>
              <th style="width:120px;">카테고리</th>
              <th style="width:140px;">음식 분류코드</th>
              <th style="width:140px;">대분류</th>
              <th style="width:140px;">중분류</th>
              <th style="width:140px;">조리법 유형</th>
            </tr>
          </thead>
          <tbody id="menuTableBody">
            <tr><td colspan="7" class="no-data"><div class="no-data-icon">📋</div>데이터를 불러오는 중…</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Streamlit이 넣어준 전역 주입값을 사용할 준비 -->
  <script>
    // Streamlit에서 window.__XLSX_BASE64__ 로 주입됨(없으면 null)
    const INJECTED_XLSX_BASE64 = (typeof window !== 'undefined' && window.__XLSX_BASE64__) ? window.__XLSX_BASE64__ : null;
  </script>

  <!-- SheetJS (XLSX 파서) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    let allMenuData = [];     // 전체 데이터
    let currentCategory = 'all';

    // XLSX 경로(정적 배포 시 사용) — Streamlit 주입이 없으면 사용됨
    const PRIMARY_XLSX  = './menu.xlsx';
    const FALLBACK_XLSX = encodeURI('./정선_음식 데이터_간식제외.xlsx');

    document.addEventListener('DOMContentLoaded', loadData);

    async function loadData() {
      // ✅ 1순위: Streamlit이 주입한 base64 엑셀
      if (INJECTED_XLSX_BASE64) {
        try {
          const binary = atob(INJECTED_XLSX_BASE64);
          const len = binary.length;
          const u8 = new Uint8Array(len);
          for (let i = 0; i < len; i++) u8[i] = binary.charCodeAt(i);
          const wb  = XLSX.read(u8, { type: 'array' });
          const sheet = wb.Sheets[wb.SheetNames[0]];
          const data = XLSX.utils.sheet_to_json(sheet, { defval: '' });
          hydrateData(data);
          return;
        } catch (e) {
          console.warn('Injected base64 parse failed, fallback to fetch()', e);
        }
      }

      // ✅ 2순위: 기존 방식(fetch)
      headExists(PRIMARY_XLSX).then(ok => ok ? parseXlsx(PRIMARY_XLSX)
        : headExists(FALLBACK_XLSX).then(ok2 => ok2 ? parseXlsx(FALLBACK_XLSX)
        : showError('XLSX 파일을 찾을 수 없습니다. menu.xlsx를 올렸는지 확인하세요.')));
    }

    function headExists(url) {
      return fetch(url, { method: 'HEAD' }).then(res => res.ok).catch(() => false);
    }

    async function parseXlsx(url) {
      try {
        const res = await fetch(url);
        const buf = await res.arrayBuffer();
        const wb  = XLSX.read(buf, { type: 'array' });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(sheet, { defval: '' });
        hydrateData(data);
      } catch (err) {
        showError('XLSX를 불러오지 못했습니다: ' + err);
      }
    }

    function hydrateData(data) {
      // 컬럼 매핑 (헤더명은 정확히 아래와 같아야 함)
      allMenuData = data.map(r => ({
        menu:   (r['Menu'] ?? '').toString().trim(),
        category: (r['Category'] ?? '').toString().trim(),
        code:   (r['음식 분류코드'] ?? '').toString().trim(),
        large:  (r['대분류'] ?? '').toString().trim(),
        middle: (r['중분류'] ?? '').toString().trim(),
        cook:   (r['조리법 유형'] ?? '').toString().trim()
      })).filter(x => x.menu);

      document.getElementById('totalCount').textContent = allMenuData.length.toLocaleString();

      // 초기 렌더: 전체
      setActiveCategoryButton('all');
      toggleAdvancedFilters(false);
      renderTable(allMenuData);
    }

    function setActiveCategoryButton(cat) {
      document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
      const label = (cat === 'all') ? '전체' : cat;
      const btn = Array.from(document.querySelectorAll('.category-btn'))
        .find(b => b.textContent.replace(/\s+.*/, '') === label);
      if (btn) btn.classList.add('active');
    }

    function filterByCategory(cat) {
      currentCategory = cat;
      setActiveCategoryButton(cat);

      if (cat === 'all') {
        toggleAdvancedFilters(false);
      } else {
        toggleAdvancedFilters(true);
        populateAdvancedOptions();
      }
      applyAllFilters();
    }

    function toggleAdvancedFilters(show) {
      document.getElementById('advancedFilters').style.display = show ? 'grid' : 'none';
      if (!show) resetAdvancedSelects();
    }

    function resetAdvancedSelects() {
      ['codeSelect','largeSelect','middleSelect','cookSelect'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = `<option value="">전체</option>`;
      });
    }

    function getBaseRowsByCategory() {
      return currentCategory === 'all'
        ? allMenuData
        : allMenuData.filter(x => x.category === currentCategory);
    }

    /* ---------- 계단식(상호연동) 드롭다운 핵심 ---------- */
    function getCurrentFilters() {
      return {
        code:   (document.getElementById('codeSelect').value   || '').trim(),
        large:  (document.getElementById('largeSelect').value  || '').trim(),
        middle: (document.getElementById('middleSelect').value || '').trim(),
        cook:   (document.getElementById('cookSelect').value   || '').trim(),
      };
    }

    function allowedValues(rows, key) {
      return Array.from(new Set(rows.map(r => r[key]).filter(Boolean)))
        .sort((a,b) => a.localeCompare(b, 'ko'));
    }

    function setSelect(id, values, current) {
      const el = document.getElementById(id);
      const cur = current || '';
      el.innerHTML = `<option value="">전체</option>` +
        values.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
      el.value = values.includes(cur) ? cur : '';
    }

    function recomputeOptions() {
      const base = getBaseRowsByCategory();
      const f    = getCurrentFilters();

      // 자기 자신을 제외한 나머지 선택 조건을 적용하여 허용값 계산
      const rowsExcept = (excludeKey) => base.filter(r =>
        (excludeKey === 'code'   || !f.code   || r.code   === f.code)   &&
        (excludeKey === 'large'  || !f.large  || r.large  === f.large)  &&
        (excludeKey === 'middle' || !f.middle || r.middle === f.middle) &&
        (excludeKey === 'cook'   || !f.cook   || r.cook   === f.cook)
      );

      const codeAllowed   = allowedValues(rowsExcept('code'),   'code');
      const largeAllowed  = allowedValues(rowsExcept('large'),  'large');
      const middleAllowed = allowedValues(rowsExcept('middle'), 'middle');
      const cookAllowed   = allowedValues(rowsExcept('cook'),   'cook');

      setSelect('codeSelect',   codeAllowed,   f.code);
      setSelect('largeSelect',  largeAllowed,  f.large);
      setSelect('middleSelect', middleAllowed, f.middle);
      setSelect('cookSelect',   cookAllowed,   f.cook);
    }

    function populateAdvancedOptions() {
      // 카테고리 전환 시 선택 초기화 후 가능한 값 계산
      ['codeSelect','largeSelect','middleSelect','cookSelect'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      recomputeOptions();
    }

    function syncCascades() {
      recomputeOptions();
    }
    /* --------------------------------------------------- */

    function applyAllFilters() {
      const kw = document.getElementById('searchInput').value.trim().toLowerCase();
      const f  = getCurrentFilters();

      let rows = getBaseRowsByCategory();
      if (kw)      rows = rows.filter(r => r.menu.toLowerCase().includes(kw));
      if (f.code)  rows = rows.filter(r => r.code   === f.code);
      if (f.large) rows = rows.filter(r => r.large  === f.large);
      if (f.middle)rows = rows.filter(r => r.middle === f.middle);
      if (f.cook)  rows = rows.filter(r => r.cook   === f.cook);

      renderTable(rows);
    }

    function renderTable(rows) {
      const tbody = document.getElementById('menuTableBody');

      if (!rows || rows.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="no-data"><div class="no-data-icon">🔍</div>표시할 메뉴가 없습니다.</td></tr>`;
        return;
      }

      tbody.innerHTML = rows.map((r, i) => `
        <tr>
          <td>${i + 1}</td>
          <td class="left">${escapeHtml(r.menu)}</td>
          <td>${escapeHtml(r.category)}</td>
          <td>${escapeHtml(r.code)}</td>
          <td>${escapeHtml(r.large)}</td>
          <td>${escapeHtml(r.middle)}</td>
          <td>${escapeHtml(r.cook)}</td>
        </tr>
      `).join('');
    }

    function showError(msg) {
      document.getElementById('menuTableBody').innerHTML =
        `<tr><td colspan="7" class="no-data"><div class="no-data-icon">⚠️</div>${msg}</td></tr>`;
    }

    function escapeHtml(s) {
      return (s || '').toString().replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      })[m]);
    }
  </script>
</body>
</html>
"""
# ==============================
# ↑↑↑ index.html 본문 끝 ↑↑↑
# ==============================


