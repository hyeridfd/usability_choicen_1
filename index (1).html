import os, base64
import streamlit as st
import streamlit.components.v1 as components

def render_index_html_with_injected_xlsx(
    html_height: int = 900,
    xlsx_candidates=None,
    html_file_path: str | None = None,
):
    """
    index.html ë‚´ìš©ì„ íŒŒì´ì¬ ë¬¸ìì—´(INDEX_HTML)ë¡œ í¬í•¨í•˜ê³ ,
    ì¡´ì¬í•˜ëŠ” ì—‘ì…€ì„ base64ë¡œ ì£¼ì…í•˜ì—¬ Streamlitì—ì„œ ë°”ë¡œ ë Œë”í•©ë‹ˆë‹¤.

    - html_file_path ë¥¼ ì£¼ë©´, ë‚´ë¶€ ë¬¸ìì—´ ëŒ€ì‹  í•´ë‹¹ íŒŒì¼ ë‚´ìš©ì„ ì‚¬ìš©í•©ë‹ˆë‹¤(ì„ íƒ).
    - xlsx_candidates ìˆœì„œëŒ€ë¡œ ì¡´ì¬ì—¬ë¶€ë¥¼ í™•ì¸í•´ ì²« ë²ˆì§¸ íŒŒì¼ì„ ì£¼ì…í•©ë‹ˆë‹¤.
    """
    if xlsx_candidates is None:
        xlsx_candidates = [
            "menu.xlsx",
        ]

    # 1) HTML ë³¸ë¬¸ ì¤€ë¹„ (íŒŒì¼ ê²½ë¡œê°€ ì£¼ì–´ì§€ë©´ íŒŒì¼ ì‚¬ìš©, ì•„ë‹ˆë©´ ë‚´ì¥ ë¬¸ìì—´ ì‚¬ìš©)
    if html_file_path and os.path.exists(html_file_path):
        try:
            with open(html_file_path, "r", encoding="utf-8") as f:
                html_content = f.read()
        except Exception:
            with open(html_file_path, "r", encoding="cp949", errors="ignore") as f:
                html_content = f.read()
    else:
        html_content = INDEX_HTML  # ì•„ë˜ì— ì •ì˜ëœ ì „ì²´ HTML ë¬¸ìì—´

    # 2) ì—‘ì…€ í›„ë³´ ì¤‘ ì²« ë²ˆì§¸ ì¡´ì¬ íŒŒì¼ì„ base64 ì¸ì½”ë”©
    xlsx_path = next((p for p in xlsx_candidates if os.path.exists(p)), None)
    if xlsx_path:
        with open(xlsx_path, "rb") as xf:
            b64 = base64.b64encode(xf.read()).decode()
        inject_script = f"<script>window.__XLSX_BASE64__='{b64}';</script>"
    else:
        # ì£¼ì… ì—†ìŒ â†’ HTML ë‚´ë¶€ì—ì„œ fetch() ê²½ë¡œë¡œ í´ë°±
        inject_script = "<script>window.__XLSX_BASE64__=null;</script>"

    # 3) ì£¼ì… ìŠ¤í¬ë¦½íŠ¸ + HTML í•©ì¹˜ê¸° í›„ ë Œë”
    final_html = inject_script + html_content
    components.html(final_html, height=html_height, scrolling=True)


# ==============================
# â†“â†“â†“ ì—¬ê¸°ë¶€í„° index.html ë³¸ë¬¸ â†“â†“â†“
# (ì£¼ì…(base64) ëª¨ë“œ + fetch í´ë°± ëª¨ë‘ ì§€ì›)
# ==============================
INDEX_HTML = r"""<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ë©”ë‰´ ê´€ë¦¬</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Malgun Gothic', sans-serif; background:#f5f5f5; color:#333; }
    .header { background:linear-gradient(to right,#5b6caa,#7b8bc4); color:#fff; padding:12px 20px; font-weight:700; display:flex; gap:10px; align-items:center; }
    .fics-logo { background:#3d4d7a; padding:4px 12px; border-radius:4px; }
    .container { background:#fff; margin:20px; border:1px solid #ddd; box-shadow:0 2px 4px rgba(0,0,0,.08); }
    .title-bar { background:#f8f9fa; padding:12px 16px; border-bottom:1px solid #e5e7eb; font-weight:700; }
    .content { padding:18px; }
    .info-section { display:flex; gap:20px; flex-wrap:wrap; margin-bottom:18px; padding:12px; background:#f8f9fa; border:1px solid #e5e7eb; border-radius:6px;}
    .info-item { display:flex; gap:8px; align-items:center; }
    .category-buttons { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:14px; }
    .category-btn { padding:8px 16px; border:1px solid #9ca3af; background:linear-gradient(to bottom,#fafafa,#e8e8e8); border-radius:6px; cursor:pointer; font-weight:600; }
    .category-btn.active { background:linear-gradient(to bottom,#5b6caa,#4a5a99); color:#fff; border-color:#3d4d7a; }
    .search-row { display:flex; gap:10px; margin-bottom:12px; align-items:center; }
    .search-input { flex:1; padding:10px 12px; border:1px solid #e5e7eb; border-radius:6px; }
    .search-btn { padding:10px 16px; border:none; border-radius:6px; background:#4a5a99; color:#fff; font-weight:700; cursor:pointer; }
    .filters { display:grid; grid-template-columns: repeat(4, minmax(160px,1fr)); gap:10px; margin-bottom:14px; }
    .filter { display:flex; flex-direction:column; gap:6px; }
    .filter label { font-size:12px; color:#6b7280; font-weight:700; }
    .filter select { padding:10px 12px; border:1px solid #e5e7eb; border-radius:6px; }
    .table-container { border:1px solid #e5e7eb; border-radius:8px; overflow:hidden; }
    table { width:100%; border-collapse:collapse; }
    thead { background:linear-gradient(to bottom,#6b7baa,#5b6b9a); color:#fff; }
    th, td { padding:12px 10px; text-align:center; border-bottom:1px solid #eef2f7; }
    tbody tr:hover { background:#f8fafc; }
    td.left { text-align:left; padding-left:18px; }
    .no-data { text-align:center; padding:36px 20px; color:#6b7280; }
    .no-data-icon { font-size:40px; opacity:.35; margin-bottom:8px; }
    .count-badge { background:#dc3545; color:#fff; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:700; }
  </style>
</head>
<body>
  <div class="header">
    <span class="fics-logo">FICS</span>
    <span>(ì£¼)ì´ˆì´ìŠ¤ì—” ë©”ë‰´ ê´€ë¦¬</span>
  </div>

  <div class="container">
    <div class="title-bar">ë©”ë‰´ê´€ë¦¬</div>
    <div class="content">
      <div class="info-section">
        <div class="info-item"><strong>â€¢ ì‚¬ì—…ì¥:</strong> (ì£¼)ì´ˆì´ìŠ¤ì—”</div>
        <div class="info-item"><strong>â€¢ ì—…íƒœ/ì¢…ëª©:</strong> ë©”ë‰´ì„¤ê³„</div>
        <div class="info-item"><strong>â€¢ ì´ ë©”ë‰´ ìˆ˜:</strong> <span id="totalCount" class="count-badge">0</span></div>
      </div>

      <div class="category-buttons">
        <button class="category-btn" onclick="filterByCategory('all', event)">ì „ì²´</button>
        <button class="category-btn" onclick="filterByCategory('ë°¥', event)">ë°¥</button>
        <button class="category-btn" onclick="filterByCategory('êµ­', event)">êµ­</button>
        <button class="category-btn" onclick="filterByCategory('ì£¼ì°¬', event)">ì£¼ì°¬</button>
        <button class="category-btn" onclick="filterByCategory('ë¶€ì°¬', event)">ë¶€ì°¬</button>
        <button class="category-btn" onclick="filterByCategory('ê¹€ì¹˜', event)">ê¹€ì¹˜</button>
      </div>

      <div class="search-row">
        <input id="searchInput" class="search-input" type="text" placeholder="ë©”ë‰´ëª… ê²€ìƒ‰â€¦" oninput="applyAllFilters()" />
        <button class="search-btn" onclick="applyAllFilters()">ê²€ìƒ‰</button>
      </div>

      <!-- ë™ì  ë“œë¡­ë‹¤ìš´(ì¹´í…Œê³ ë¦¬ ì„ íƒ ì‹œ ë…¸ì¶œ) -->
      <div id="advancedFilters" class="filters" style="display:none;">
        <div class="filter">
          <label for="codeSelect">ìŒì‹ ë¶„ë¥˜ì½”ë“œ</label>
          <select id="codeSelect" onchange="syncCascades(); applyAllFilters();"></select>
        </div>
        <div class="filter">
          <label for="largeSelect">ëŒ€ë¶„ë¥˜</label>
          <select id="largeSelect" onchange="syncCascades(); applyAllFilters();"></select>
        </div>
        <div class="filter">
          <label for="middleSelect">ì¤‘ë¶„ë¥˜</label>
          <select id="middleSelect" onchange="syncCascades(); applyAllFilters();"></select>
        </div>
        <div class="filter">
          <label for="cookSelect">ì¡°ë¦¬ë²• ìœ í˜•</label>
          <select id="cookSelect" onchange="syncCascades(); applyAllFilters();"></select>
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th style="width:60px;">#</th>
              <th>ë©”ë‰´ëª…</th>
              <th style="width:120px;">ì¹´í…Œê³ ë¦¬</th>
              <th style="width:140px;">ìŒì‹ ë¶„ë¥˜ì½”ë“œ</th>
              <th style="width:140px;">ëŒ€ë¶„ë¥˜</th>
              <th style="width:140px;">ì¤‘ë¶„ë¥˜</th>
              <th style="width:140px;">ì¡°ë¦¬ë²• ìœ í˜•</th>
            </tr>
          </thead>
          <tbody id="menuTableBody">
            <tr><td colspan="7" class="no-data"><div class="no-data-icon">ğŸ“‹</div>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Streamlitì´ ë„£ì–´ì¤€ ì „ì—­ ì£¼ì…ê°’ì„ ì‚¬ìš©í•  ì¤€ë¹„ -->
  <script>
    // Streamlitì—ì„œ window.__XLSX_BASE64__ ë¡œ ì£¼ì…ë¨(ì—†ìœ¼ë©´ null)
    const INJECTED_XLSX_BASE64 = (typeof window !== 'undefined' && window.__XLSX_BASE64__) ? window.__XLSX_BASE64__ : null;
  </script>

  <!-- SheetJS (XLSX íŒŒì„œ) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
    let allMenuData = [];     // ì „ì²´ ë°ì´í„°
    let currentCategory = 'all';

    // XLSX ê²½ë¡œ(ì •ì  ë°°í¬ ì‹œ ì‚¬ìš©) â€” Streamlit ì£¼ì…ì´ ì—†ìœ¼ë©´ ì‚¬ìš©ë¨
    const PRIMARY_XLSX  = './menu.xlsx';
    const FALLBACK_XLSX = encodeURI('./ì •ì„ _ìŒì‹ ë°ì´í„°_ê°„ì‹ì œì™¸.xlsx');

    document.addEventListener('DOMContentLoaded', loadData);

    async function loadData() {
      // âœ… 1ìˆœìœ„: Streamlitì´ ì£¼ì…í•œ base64 ì—‘ì…€
      if (INJECTED_XLSX_BASE64) {
        try {
          const binary = atob(INJECTED_XLSX_BASE64);
          const len = binary.length;
          const u8 = new Uint8Array(len);
          for (let i = 0; i < len; i++) u8[i] = binary.charCodeAt(i);
          const wb  = XLSX.read(u8, { type: 'array' });
          const sheet = wb.Sheets[wb.SheetNames[0]];
          const data = XLSX.utils.sheet_to_json(sheet, { defval: '' });
          hydrateData(data);
          return;
        } catch (e) {
          console.warn('Injected base64 parse failed, fallback to fetch()', e);
        }
      }

      // âœ… 2ìˆœìœ„: ê¸°ì¡´ ë°©ì‹(fetch)
      headExists(PRIMARY_XLSX).then(ok => ok ? parseXlsx(PRIMARY_XLSX)
        : headExists(FALLBACK_XLSX).then(ok2 => ok2 ? parseXlsx(FALLBACK_XLSX)
        : showError('XLSX íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. menu.xlsxë¥¼ ì˜¬ë ¸ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.')));
    }

    function headExists(url) {
      return fetch(url, { method: 'HEAD' }).then(res => res.ok).catch(() => false);
    }

    async function parseXlsx(url) {
      try {
        const res = await fetch(url);
        const buf = await res.arrayBuffer();
        const wb  = XLSX.read(buf, { type: 'array' });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(sheet, { defval: '' });
        hydrateData(data);
      } catch (err) {
        showError('XLSXë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: ' + err);
      }
    }

    function hydrateData(data) {
      // ì»¬ëŸ¼ ë§¤í•‘ (í—¤ë”ëª…ì€ ì •í™•íˆ ì•„ë˜ì™€ ê°™ì•„ì•¼ í•¨)
      allMenuData = data.map(r => ({
        menu:   (r['Menu'] ?? '').toString().trim(),
        category: (r['Category'] ?? '').toString().trim(),
        code:   (r['ìŒì‹ ë¶„ë¥˜ì½”ë“œ'] ?? '').toString().trim(),
        large:  (r['ëŒ€ë¶„ë¥˜'] ?? '').toString().trim(),
        middle: (r['ì¤‘ë¶„ë¥˜'] ?? '').toString().trim(),
        cook:   (r['ì¡°ë¦¬ë²• ìœ í˜•'] ?? '').toString().trim()
      })).filter(x => x.menu);

      document.getElementById('totalCount').textContent = allMenuData.length.toLocaleString();

      // ì´ˆê¸° ë Œë”: ì „ì²´
      setActiveCategoryButton('all');
      toggleAdvancedFilters(false);
      renderTable(allMenuData);
    }

    function setActiveCategoryButton(cat) {
      document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
      const label = (cat === 'all') ? 'ì „ì²´' : cat;
      const btn = Array.from(document.querySelectorAll('.category-btn'))
        .find(b => b.textContent.replace(/\s+.*/, '') === label);
      if (btn) btn.classList.add('active');
    }

    function filterByCategory(cat) {
      currentCategory = cat;
      setActiveCategoryButton(cat);

      if (cat === 'all') {
        toggleAdvancedFilters(false);
      } else {
        toggleAdvancedFilters(true);
        populateAdvancedOptions();
      }
      applyAllFilters();
    }

    function toggleAdvancedFilters(show) {
      document.getElementById('advancedFilters').style.display = show ? 'grid' : 'none';
      if (!show) resetAdvancedSelects();
    }

    function resetAdvancedSelects() {
      ['codeSelect','largeSelect','middleSelect','cookSelect'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = `<option value="">ì „ì²´</option>`;
      });
    }

    function getBaseRowsByCategory() {
      return currentCategory === 'all'
        ? allMenuData
        : allMenuData.filter(x => x.category === currentCategory);
    }

    /* ---------- ê³„ë‹¨ì‹(ìƒí˜¸ì—°ë™) ë“œë¡­ë‹¤ìš´ í•µì‹¬ ---------- */
    function getCurrentFilters() {
      return {
        code:   (document.getElementById('codeSelect').value   || '').trim(),
        large:  (document.getElementById('largeSelect').value  || '').trim(),
        middle: (document.getElementById('middleSelect').value || '').trim(),
        cook:   (document.getElementById('cookSelect').value   || '').trim(),
      };
    }

    function allowedValues(rows, key) {
      return Array.from(new Set(rows.map(r => r[key]).filter(Boolean)))
        .sort((a,b) => a.localeCompare(b, 'ko'));
    }

    function setSelect(id, values, current) {
      const el = document.getElementById(id);
      const cur = current || '';
      el.innerHTML = `<option value="">ì „ì²´</option>` +
        values.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
      el.value = values.includes(cur) ? cur : '';
    }

    function recomputeOptions() {
      const base = getBaseRowsByCategory();
      const f    = getCurrentFilters();

      // ìê¸° ìì‹ ì„ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ì„ íƒ ì¡°ê±´ì„ ì ìš©í•˜ì—¬ í—ˆìš©ê°’ ê³„ì‚°
      const rowsExcept = (excludeKey) => base.filter(r =>
        (excludeKey === 'code'   || !f.code   || r.code   === f.code)   &&
        (excludeKey === 'large'  || !f.large  || r.large  === f.large)  &&
        (excludeKey === 'middle' || !f.middle || r.middle === f.middle) &&
        (excludeKey === 'cook'   || !f.cook   || r.cook   === f.cook)
      );

      const codeAllowed   = allowedValues(rowsExcept('code'),   'code');
      const largeAllowed  = allowedValues(rowsExcept('large'),  'large');
      const middleAllowed = allowedValues(rowsExcept('middle'), 'middle');
      const cookAllowed   = allowedValues(rowsExcept('cook'),   'cook');

      setSelect('codeSelect',   codeAllowed,   f.code);
      setSelect('largeSelect',  largeAllowed,  f.large);
      setSelect('middleSelect', middleAllowed, f.middle);
      setSelect('cookSelect',   cookAllowed,   f.cook);
    }

    function populateAdvancedOptions() {
      // ì¹´í…Œê³ ë¦¬ ì „í™˜ ì‹œ ì„ íƒ ì´ˆê¸°í™” í›„ ê°€ëŠ¥í•œ ê°’ ê³„ì‚°
      ['codeSelect','largeSelect','middleSelect','cookSelect'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      recomputeOptions();
    }

    function syncCascades() {
      recomputeOptions();
    }
    /* --------------------------------------------------- */

    function applyAllFilters() {
      const kw = document.getElementById('searchInput').value.trim().toLowerCase();
      const f  = getCurrentFilters();

      let rows = getBaseRowsByCategory();
      if (kw)      rows = rows.filter(r => r.menu.toLowerCase().includes(kw));
      if (f.code)  rows = rows.filter(r => r.code   === f.code);
      if (f.large) rows = rows.filter(r => r.large  === f.large);
      if (f.middle)rows = rows.filter(r => r.middle === f.middle);
      if (f.cook)  rows = rows.filter(r => r.cook   === f.cook);

      renderTable(rows);
    }

    function renderTable(rows) {
      const tbody = document.getElementById('menuTableBody');

      if (!rows || rows.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="no-data"><div class="no-data-icon">ğŸ”</div>í‘œì‹œí•  ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
        return;
      }

      tbody.innerHTML = rows.map((r, i) => `
        <tr>
          <td>${i + 1}</td>
          <td class="left">${escapeHtml(r.menu)}</td>
          <td>${escapeHtml(r.category)}</td>
          <td>${escapeHtml(r.code)}</td>
          <td>${escapeHtml(r.large)}</td>
          <td>${escapeHtml(r.middle)}</td>
          <td>${escapeHtml(r.cook)}</td>
        </tr>
      `).join('');
    }

    function showError(msg) {
      document.getElementById('menuTableBody').innerHTML =
        `<tr><td colspan="7" class="no-data"><div class="no-data-icon">âš ï¸</div>${msg}</td></tr>`;
    }

    function escapeHtml(s) {
      return (s || '').toString().replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      })[m]);
    }
  </script>
</body>
</html>
"""
# ==============================
# â†‘â†‘â†‘ index.html ë³¸ë¬¸ ë â†‘â†‘â†‘
# ==============================


